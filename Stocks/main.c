/*
 * LED matrix driver adapted from http://linksprite.com/wiki/index.php5?title=LED_Matrix_Kit#Software
 */
#include <fsl_device_registers.h>
#include <string.h>
#include <ctype.h>

/*
 * Used for digital_write()
 */
#define CS		0 // PTD0
#define CLK 	1 // PTD1
#define DIN 	2 // PTD2
#define LOW 	0
#define HIGH	1

/*
 * used for pause()
 */
#define DATA_DELAY		2
#define SCROLL_DELAY 	1000000

/*
 * Current display state of the led matrix
 */
int STATE[8] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};

/*
 * Drives specified gpio pin low or high
 * port: CS = 0, CLK = 1, DIN = 2
 * direction: low = 0, high = 1
 */
void digital_write(int port, int direction) {
	if (direction) {
		PTD->PSOR |= (1 << port);
	} else {
		PTD->PCOR |= (1 << port);
	}
}

/*
 * Busy wait
 */
void pause(int i) {
	int j;
	for (j = 0; j < i; j++);
}



/*
 * Writes a byte of data through DIN
 */
void write_byte(int data_byte) {
	int i;
	digital_write(CS, LOW);
	for (i = 0; i < 8; i++) {
		digital_write(CLK, LOW);
		digital_write(DIN, data_byte & 0x80);
		data_byte = data_byte << 1;
		pause(DATA_DELAY);
		digital_write(CLK, HIGH);
	}
}

/*
 * Writes data to an address of the led matrix
 */
void write(int address, int data) {
	digital_write(CS, LOW);
	write_byte(address);
	write_byte(data);
	digital_write(CS, HIGH);
}

/*
 * Resets led matrix display
 */
void clear_display() {
	int i;
	for (i = 1; i <= 8; i++){
		write(i, 0);
	}
}

/*
 * Setup for ports and led matrix
 */
void setup() {
	// ports
	SIM->SCGC5 |= SIM_SCGC5_PORTD_MASK;
	PORTD->PCR[CLK] = PORT_PCR_MUX(001);
	PORTD->PCR[CS] = PORT_PCR_MUX(001);
	PORTD->PCR[DIN] = PORT_PCR_MUX(001);
	GPIOD_PDDR |= (1 << CLK);
	GPIOD_PDDR |= (1 << CS); 
	GPIOD_PDDR |= (1 << DIN);
	digital_write(CS, LOW);
	
	// led matrix
	write(9, 0); // decoding
	write(11, 7); // scanlimit
	write(12, 1); // normal power-down mode
	clear_display();
}

/*
 * Move display one unit left, leaving right most column empty
 */
void shift() {
	int i;
	for (i = 7; i >= 1; i--) {
		STATE[i] = STATE[i-1];
		write(i+1, STATE[i]);
	}
	STATE[0] = 0;
	write(1, STATE[0]);
}

/*
 * Struct for displaying characters
 * c = char represented, len = # of columns needed for display, cols = data to pass to led matrix
 */
typedef struct {
	char c;
  int len;
  int cols[8];
} char_t;

/*
 * Scrolls c accross the display
 */
void scroll(char_t c) {
	int i;
	for (i = 0; i < c.len; i++) {
		shift();
		STATE[0] = c.cols[i];
		write(1, STATE[0]);
		pause(SCROLL_DELAY);
	}
	shift();
	pause(SCROLL_DELAY);
}

/*
 * Library of char_t
 */
int char_t_library_len = 41;
char_t char_t_library[] = {
	{'0', 3, {0x3E,0x22,0x3E,0x00,0x00,0x00,0x00,0x00}},
	{'1', 1, {0x3E,0x00,0x00,0x00,0x00,0x00,0x00,0x00}},
  {'2', 3, {0x2E,0x2A,0x3A,0x00,0x00,0x00,0x00,0x00}},
	{'3', 3, {0x2A,0x2A,0x3E,0x00,0x00,0x00,0x00,0x00}},
	{'4', 3, {0x38,0x08,0x3E,0x00,0x00,0x00,0x00,0x00}},
	{'5', 3, {0x3A,0x2A,0x2E,0x00,0x00,0x00,0x00,0x00}},
	{'6', 3, {0x3E,0x2A,0x2E,0x00,0x00,0x00,0x00,0x00}},
	{'7', 3, {0x20,0x20,0x3E,0x00,0x00,0x00,0x00,0x00}},
	{'8', 3, {0x3E,0x2A,0x3E,0x00,0x00,0x00,0x00,0x00}},
	{'9', 3, {0x38,0x28,0x3E,0x00,0x00,0x00,0x00,0x00}},
	{'A', 3, {0x3E,0x28,0x3E,0x00,0x00,0x00,0x00,0x00}},
	{'B', 3, {0x3E,0x2A,0x36,0x00,0x00,0x00,0x00,0x00}},
	{'C', 3, {0x1C,0x22,0x22,0x00,0x00,0x00,0x00,0x00}},
	{'D', 3, {0x3E,0x22,0x1C,0x00,0x00,0x00,0x00,0x00}},
	{'E', 3, {0x3E,0x2A,0x22,0x00,0x00,0x00,0x00,0x00}},
	{'F', 3, {0x3E,0x28,0x20,0x00,0x00,0x00,0x00,0x00}},
	{'G', 3, {0x1C,0x22,0x2E,0x00,0x00,0x00,0x00,0x00}},
	{'H', 3, {0x3E,0x8,0x3E,0x00,0x00,0x00,0x00,0x00}},
	{'I', 3, {0x22,0x3E,0x22,0x00,0x00,0x00,0x00,0x00}},
	{'J', 3, {0x24,0x22,0x3E,0x00,0x00,0x00,0x00,0x00}},
	{'K', 4, {0x3E,0x8,0x14,0x22,0x00,0x00,0x00,0x00}},
	{'L', 3, {0x3E,0x2,0x2,0x00,0x00,0x00,0x00,0x00}},
	{'M', 5, {0x3E,0x10,0x8,0x10,0x3E,0x00,0x00,0x00}},
	{'N', 5, {0x3E,0x10,0xC,0x2,0x3E,0x00,0x00,0x00}},
	{'O', 3, {0x3E,0x22,0x3E,0x00,0x00,0x00,0x00,0x00}},
	{'P', 3, {0x3E,0x28,0x38,0x00,0x00,0x00,0x00,0x00}},
	{'Q', 4, {0x1C,0x22,0x24,0x1A,0x00,0x00,0x00,0x00}},
	{'R', 3, {0x3E,0x28,0x36,0x00,0x00,0x00,0x00,0x00}},
	{'S', 3, {0x1A,0x2A,0x2C,0x00,0x00,0x00,0x00,0x00}},
	{'T', 3, {0x20,0x3E,0x20,0x00,0x00,0x00,0x00,0x00}},
	{'U', 3, {0x3E,0x2,0x3E,0x00,0x00,0x00,0x00,0x00}},
	{'V', 3, {0x3C,0x2,0x3C,0x00,0x00,0x00,0x00,0x00}},
	{'W', 5, {0x3E,0x4,0x8,0x4,0x3E,0x00,0x00,0x00}},
	{'X', 3, {0x36,0x8,0x36,0x00,0x00,0x00,0x00,0x00}},
	{'Y', 3, {0x30,0xE,0x30,0x00,0x00,0x00,0x00,0x00}},
	{'Z', 3, {0x26,0x2A,0x32,0x00,0x00,0x00,0x00,0x00}},
	{' ', 2, {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}},
	{'.', 1, {0x2,0x00,0x00,0x00,0x00,0x00,0x00,0x00}},
	{'%', 5, {0x32,0x34,0x8,0x16,0x26,0x00,0x00,0x00}},
	{'+', 5, {0x10,0x20,0x7E,0x20,0x10,0x00,0x00,0x00}},
	{'-', 5, {0x8,0x4,0x7E,0x4,0x8,0x00,0x00,0x00}}
};
 
/*
 * Converts char to char_t
 */
char_t char2char_t(char c) {
	int i;
	for (i = 0; i < char_t_library_len; i++) {
		
		if (c == char_t_library[i].c || c == toupper(char_t_library[i].c)) {
			return char_t_library[i];
		}
	}
	// no match, return some default
	return (char_t) {'\0', 0, {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}};
}

/*
 * Displays s on the led matrix
 */
void display_string(char s[]) {
	int i;
	for (i = 0; i < strlen(s); i++) {
		scroll(char2char_t(s[i]));
	}
}


int main() {
	setup();
	display_string("GOOGL -0.08%  AAPL +1.40%  FB +0.19%  AMZN +1.45%  MSFT -0.12%");
}

